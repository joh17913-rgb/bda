import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
from sklearn.model_selection import train_test_split
from sklearn.ensemble import HistGradientBoostingClassifier
from sklearn.metrics import f1_score, precision_score, recall_score, accuracy_score
from sklearn.preprocessing import LabelEncoder

# 1. 데이터 로드
train = pd.read_csv('train.csv')
test = pd.read_csv('test.csv')

# 2. 전처리 함수 (성실성 지표 + 핵심 변수)
def preprocess_v3(df):
    new_df = pd.DataFrame()
    
    # [성실성 지표] 주관식 답변 길이
    text_cols = ['onedayclass_topic', 'what_to_gain', 'whyBDA', 'incumbents_lecture_scale_reason']
    for col in text_cols:
        new_df[f'{col}_len'] = df[col].astype(str).apply(len)
    
    # [준비도/환경 지표] 자격증 개수 및 가용 시간
    new_df['cert_count'] = df['certificate_acquisition'].apply(
        lambda x: 0 if pd.isna(x) or str(x) in ['없음', ''] else len(str(x).split(','))
    )
    new_df['time_input'] = df['time_input'].fillna(df['time_input'].median())
    
    # [배경 변수] 학교, 전공여부, 직업 등
    key_cats = ['school1', 'major_data', 'generation', 'job', 'project_type']
    for col in key_cats:
        le = LabelEncoder()
        # 학습/테스트 통합 인코딩 (일관성 유지)
        combined_series = pd.concat([train[col], test[col]]).astype(str)
        le.fit(combined_series)
        new_df[col] = le.transform(df[col].astype(str))
        
    return new_df

# 특징 추출
X = preprocess_v3(train)
y = train['completed']
X_test_final = preprocess_v3(test)

# 3. 모델 학습 (확률 예측을 위함)
X_train, X_val, y_train, y_val = train_test_split(X, y, test_size=0.2, random_state=42, stratify=y)

model = HistGradientBoostingClassifier(random_state=42, class_weight='balanced')
model.fit(X_train, y_train)

# 검증 데이터에서 '수료할 확률' 추출
y_probs = model.predict_proba(X_val)[:, 1]

# 4. 임계치(Threshold) 최적화 및 시각화
thresholds = np.arange(0.05, 0.95, 0.01)
f1_scores = []
precisions = []
recalls = []

for t in thresholds:
    y_pred_t = (y_probs >= t).astype(int)
    f1_scores.append(f1_score(y_val, y_pred_t))
    precisions.append(precision_score(y_val, y_pred_t, zero_division=0))
    recalls.append(recall_score(y_val, y_pred_t))

# F1-score가 최대가 되는 최적 임계치 선정
best_idx = np.argmax(f1_scores)
best_threshold = thresholds[best_idx]

print(f"최적 임계치: {best_threshold:.2f}")
print(f"최대 F1-Score: {f1_scores[best_idx]:.4f}")

# 5. 임계치별 성능 그래프 생성
plt.figure(figsize=(10, 6))
plt.plot(thresholds, f1_scores, label='F1-Score', color='red', linewidth=2)
plt.plot(thresholds, precisions, label='Precision', linestyle='--')
plt.plot(thresholds, recalls, label='Recall', linestyle='--')
plt.axvline(best_threshold, color='black', linestyle=':', label=f'Best Threshold ({best_threshold:.2f})')
plt.title('Performance Metrics by Threshold')
plt.xlabel('Threshold')
plt.ylabel('Score')
plt.legend()
plt.grid(True)
plt.savefig('threshold_analysis.png') # 이미지 저장

# 6. 최적 임계치를 적용한 최종 제출 파일 생성
model.fit(X, y) # 전체 데이터로 재학습
final_probs = model.predict_proba(X_test_final)[:, 1]
final_preds = (final_probs >= best_threshold).astype(int)

submission = pd.DataFrame({'ID': test['ID'], 'completed': final_preds})
submission.to_csv('threshold_optimized_submission.csv', index=False)

# 성능 지표 기록 저장
threshold_df = pd.DataFrame({
    'Threshold': thresholds,
    'F1_Score': f1_scores,
    'Precision': precisions,
    'Recall': recalls
})
threshold_df.to_csv('threshold_metrics.csv', index=False)

print("\n--- 모든 과정 완료 ---")
print(f"1. 최적 임계치({best_threshold:.2f})가 반영된 'threshold_optimized_submission.csv'")
print("2. 임계치 변화에 따른 성능 차트 'threshold_analysis.png'")
print("3. 상세 지표 리스트 'threshold_metrics.csv'")
